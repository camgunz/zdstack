#!/usr/bin/env python

import sys
import getopt
import pprint

from ZDStack import set_configfile, load_configparser, get_server_proxy
from ZDStack.Utils import send_server_method

def print_usage(msg=None):
    if msg:
        print >> sys.stderr, "\nError: %s" % (msg)
    print >> sys.stderr, """\nzdrpc\n
Usage:
    zdrpc -m [ rpc_method_name ] -a [ args ] -c [ config_file ]

    args are separated by commas, for example:

        zdrpc -m get_config -a "Great CTF"
        zdrpc -m addban -a "Great CTF,12.226.97.20,rofl"
"""
    sys.exit(-1)

try:
    opts, args = getopt.gnu_getopt(sys.argv[1:], 'm:a:c:', [])
except getopt.GetoptError, ge:
    print_usage(ge)
if len(opts) not in (1, 2, 3):
    print_usage("Invalid number of arguments")
opts = dict(opts)
if '-c' in opts:
    set_configfile(opts['-c'])
load_configparser()
proxy = get_server_proxy()

if '-a'in opts:
    args = [x for x in opts['-a'].split(',') if x]
else:
    args = []
function_kwarg_str = ', '.join(args)
call_string = opts['-m'] + "(" + function_kwarg_str + ")"
print "Running %s" % (call_string)
pprint.pprint(send_proxy_method(proxy, opts['-m'], *args))

