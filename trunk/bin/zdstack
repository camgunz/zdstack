#!/usr/local/bin/python -u

import os
import sys
import time
import getopt
import signal

from ZDStack import set_debugging, set_configfile, get_configparser, \
                    initialize_database, get_server_proxy


def print_usage(msg=None):
    if msg:
        print >> sys.stderr, msg
    script_name = os.path.basename(os.path.expanduser(sys.argv[0]))
    print >> sys.stderr, """\n%s\n
Usage: %s [ start | stop | restart | reload-config ] [ -c config file ]
""" % (script_name, script_name)
    sys.exit(-1)

def start(config_file, debug=False, restart=False):
    try:
        sys.stdout.flush()
        sys.stderr.flush()
        sys.stdin.close()
        sys.stdout.close()
        sys.stderr.close()
        for fd in range(1, 1025):
            try:
                os.close(fd)
            except OSError, e:
                if e.errno == 9:
                    ###
                    # Bad file descriptor, fd wasn't open.
                    ###
                    continue
                else:
                    raise
        from ZDStack import set_debugging, set_configfile, get_configparser
        if debug:
            set_debugging(True)
        if config_file:
            set_configfile(config_file)
        cp = get_configparser()
        pid_file = cp.getpath('DEFAULT', 'zdstack_pid_file')
        if os.path.isfile(pid_file):
            if restart:
                es = "\nZDStack is still running: %s\n"
            else:
                es = "\nZDStack is already running: %s\n"
            print >> sys.stderr, es % (pid_file)
            sys.exit(-1)
        print "\nStarting ZDStack\n"
        if os.fork():
            os._exit(0)
        os.chdir('/')
        os.umask(0)
        os.setsid()
        if os.fork():
            os._exit(0)
        ###
        # We used to not close this stuff if debugging was on, but if we leave
        # them open and the buffer fills up, ZDStack crashes - no good.
        ###
        # sys.stdin = open(devnull, 'r')
        # sys.stdout = open(devnull, 'a+')
        # sys.stderr = open(devnull, 'a+')
        initialize_database()
        from ZDStack.Stack import Stack
        Stack().startup()
    except Exception, e:
        if debug:
            raise
        print >> sys.stderr, "\nError: %s\n" % (str(e))
        sys.exit(-1)

def stop(config_file):
    from ZDStack import set_configfile, get_configparser
    try:
        set_configfile(opts['-c'])
        cp = get_configparser()
        pid_file = cp.getpath('DEFAULT', 'zdstack_pid_file')
        try:
            pid_fobj = open(pid_file)
            pid = int(pid_fobj.read())
            pid_fobj.close()
            os.kill(pid, signal.SIGTERM)
            print "\nStopping ZDStack\n"
        except (OSError, IOError):
            if os.path.isfile(pid_file):
                es = "\nZDStack not running, removing stale PID file.\n"
                print >> sys.stderr, es
                os.unlink(pid_file)
            else:
                es = "\nZDStack not running\n"
                print >> sys.stderr, es
                sys.exit(-1)
    except Exception, e:
        print >> sys.stderr, "\nError: %s\n" % (str(e))
        sys.exit(-1)

def restart():
    print "\nRestarting ZDStack"
    stop()
    print "Waiting for ZDStack to shut down"
    time.sleep(5)
    start()

def reload_config()
    from ZDStack import get_configparser, get_server_proxy
    cp = get_configparser() # implicitly loads the configuration file as well
    username = cp.get('DEFAULT', 'zdstack_username')
    password = cp.get('DEFAULT', 'zdstack_password')
    get_server_proxy().reload_config(username, password)

actions = ('start', 'stop', 'restart', 'debug', 'reload-config')
try:
    opts, args = getopt.gnu_getopt(sys.argv[1:], 'c:', [])
except getopt.GetoptError, ge:
    print >> sys.stderr, "Error: %s" % (ge)
    print_usage()
if len(args) != 1 or args[0] not in actions:
    print >> sys.stderr, "Error: %s" % \
            ("Invalid number of arguments, or invalid action specified")
    print_usage()
opts = dict(opts)
action = args[0]
config_file = None
if '-c' in opts:
    config_file = opts['-c']
if action == 'debug':
    start(debug=True)
elif action == 'start':
    start()
elif action == 'stop':
    stop()
elif action == 'restart':
    restart()
elif action == 'reload-config':
    reload_config()

